;*******************************************************************************
;
;	ИНИЦИАЛИЗАЦИЯ    РЕГИСТРОВ   МИКРОКОНТРОЛЛЕРА  PIC16F628A
;
;*******************************************************************************
    
init:
    errorlevel -302 ;не напоминать что банк не 0
    ;--------------------------------------------------------------------------
    ;	BANK 0
    ;--------------------------------------------------------------------------
    bcf	    STATUS, RP0
    bcf	    STATUS, RP1	    ;переход в банк 0 для доступа к регистрам банка 0
    ;INDF - обращение к регистру , адрес которого записан в FSR
    movlw .100
    movwf TMR0 ;подстройка TMR0
    ;PCL - младшие биты счетчика команд
    clrf    STATUS	    ;очистим STATUS
    ;FSR - регистр адреса при косвенной адресации
    ;настроим начальные уровни на выходах портов вывода
    clrf    PORTA 
    clrf    PORTB
    clrf    PORTC
    clrf    PORTD
    clrf    PORTE
    clrf    PCLATH	    ;Подтвердим нулевое значеие в регистре защелке
                            ;старших битов адреса команд
    movlw   b'00100000'	    ;запрет прерываний всем кроме TMR0
    movwf   INTCON
    ;PIR1	;флаги прерываний
    ;PIR2	;флаги прерываний EEPROM
    ;TMR1L	;младшие биты TMR1
    ;TMR1H	;старшие биты TMR1 
    movlw b'00110001'
    movwf T1CON ;1:8, Fosc/4, TMR1 ON, gen OFF, sync off
    ;TMR2	;регистр таймера 2
    ;T2CON
    ;SSPBUF
    ;SSPCON
    ;CCPR1L	;младший байт ШИМ CCP1
    ;CCPR1H	;старший байт ШИМ CCP1
    movlw   b'00000000'	    ;выключаем ШИМ CCP1
    movwf   CCP1CON
    movlw   b'10010000'	    ;USART ON, 8 разрядов
    movwf    RCSTA	    
    ;TXREG	;регистр данных передатчика USART
    ;RXREG	;регистр данных приемника USART
    ;CCPR2L	;младший байт ШИМ CCP2
    ;CCPR2H	;старший байт ШИМ CCP2
    ;CPP2CON
    ;ADRESH
    movlw b'10000001' ;Fosc/32,RA0,DONE,ADC On
    movwf ADCON0
    ;--------------------------------------------------------------------------
    ;	BANK 1
    ;--------------------------------------------------------------------------
    
    bsf	    STATUS, RP0
    ;INDF	;обращение к регистру , адрес которого записан в FSR
    movlw   b'11010111'
    movwf   OPTION_REG ;Предделитель перед TMR0 коэффициент 1:256
    ;PCL	;младшие биты счетчика команд
    ;STATUS 
    ;FSR	;регистр адреса при косвенной адресации
    movlw   b'00011111'	    ; 0,1,2,3,4 - входы
    movwf   TRISA
    movlw   b'00000000'	    ; все выходы
    movwf   TRISB
    movlw   b'11000000'     ;6,7 - входы для USART
    movwf   TRISC
    movlw   b'00000000'	    ;все выходы
    movwf   TRISD
    movlw   b'00000000'	    ;все выходы
    movwf   TRISE
    ;PCLATH
    ;INTCON
    ;clrf    PIE1 & 0x7F    ;запретили все периферийные прерывания
    
    clrf    PIE1	    ;запрет прерываний 
    bsf PIE1, RCIE	    ;разрешим прерывания приемника USART
    bsf	PIE1, TXIE	    ;разрешим прерывания передатчика USART
    bsf PIE1, ADIE	    ;разрешим прерывания по окончанию преобразования АЦП
    bsf PIE1, TMR1IE	    ;разрешим прерывания TMR1
    clrf    PIE2	    ;запрет всех прерываний EEPROM
    ;PCON
    ;SSPCON2
    ;PR2	;регистр периода TMR2
    ;SSPADD	;регистр адреса/регистр генератора скорости обмена
    ;SSPSTAT
    movlw   b'10100110' ;внутренний CLK, 8 bit, async, hi-speed
    movwf   TXSTA	;регистр управления и статуса USART
    movlw   b'10000001'
    movwf   SPBRG	;регистр генератора скорости USART, 129 = 9600 бод, ошибка 0,16%
    ;ADRESL
    movlw   b'00001111' ;левое выравнивание ADRESL (00xxxxxx), RA3-RA2 +- Vref
    movwf   ADCON1
    
    ;--------------------------------------------------------------------------
    ;	BANK 2
    ;--------------------------------------------------------------------------
    ;bcf STATUS, RP0
    ;bsf STATUS, RP1
    ;INDF	;обращение к регистру , адрес которого записан в FSR
    ;TMR0	;регистр таймера TMR0
    ;PCL	;младшие биты счетчика команд
    ;STATUS
    ;FSR	;регистр адреса при косвенной адресации
    ;PORTB	;запись в выходную защелку PORTB, чтение состояния выводов PORTB
    ;PCLATH	;старшие биты счетчика команд
    ;INTCON
    ;EEDATA	;регистр данных, младший байт
    ;EEADDR	;регистр адреса, младший байт
    ;EEDATH
    ;EEADRH
    
    ;--------------------------------------------------------------------------
    ;	BANK 3
    ;--------------------------------------------------------------------------
    ;bsf STATUS, RP0
    ;bsf STATUS, RP1
    ;INDF	;обращение к регистру , адрес которого записан в FSR
    ;OPTION_REG
    ;PCL	;младшие биты счетчика команд
    ;STATUS
    ;FSR	;регистр адреса при косвенной адресации
    ;TRISB	;направление выводов PORTB
    ;PCLATH	;старшие биты счетчика команд
    ;INTCON
    ;EECON1	;регистр управления 1
    ;EECON2	;регистр управления 2
    bcf	    STATUS, RP0
    bcf	    STATUS, RP1	    ;возврат в BANK 0 


    return

#INCLUDE Memory.inc 
; Init End ---------------------------------------------------------------------





